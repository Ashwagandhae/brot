<script lang="ts" generics="T">
  import BoldChars from "./BoldChars.svelte";
  import type { CommandChoice } from "./command";
  import Icon from "./Icon.svelte";
  import { platform } from "./platform";
  import Shortcut from "./Shortcut.svelte";
  import Title from "./Title.svelte";

  let {
    command,
    selected,
    container,
    onclick,
  }: {
    command: CommandChoice<T>;
    selected: boolean;
    container: HTMLElement;
    onclick?: (event: MouseEvent) => void;
  } = $props();

  let element: HTMLElement;

  function isElementFullyInContainerView(
    el: HTMLElement,
    container: HTMLElement
  ): boolean {
    const elRect = el.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();

    return (
      elRect.top >= containerRect.top &&
      elRect.bottom <= containerRect.bottom &&
      elRect.left >= containerRect.left &&
      elRect.right <= containerRect.right
    );
  }

  $effect(() => {
    if (selected) {
      if (!isElementFullyInContainerView(element, container)) {
        element.scrollIntoView({
          block: "nearest",
          inline: "nearest",
        });
      }
    }
  });
</script>

<button
  class="top"
  class:selected
  bind:this={element}
  onmousedown={(event) => event.preventDefault()}
  {onclick}
>
  <div class="left">
    <div class="icon">
      <Icon name={command.icon ?? "dots"}></Icon>
    </div>
    <div class="title" class:path={command.path}>
      {#if command.path == null}
        <BoldChars text={command.title} indices={command.indices}></BoldChars>
      {:else}
        <Title path={command.path}></Title>
      {/if}
    </div>
  </div>
  {#if command.shortcut != null && $platform != "android"}
    <div class="shortcut">
      <Shortcut keyString={command.shortcut} {selected}></Shortcut>
    </div>
  {/if}
</button>

<style>
  .top {
    width: 100%;
    font-size: 16px;
    height: 32px;
    line-height: 1;
    box-sizing: border-box;
    border-radius: 8px;

    display: flex;
    flex-direction: row;
    justify-content: space-between;
    background: none;
  }
  .left {
    display: flex;
    flex-direction: row;
  }
  .title {
    padding: 8px 8px 8px 0;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .title.path {
    padding: 6px 6px 6px 0;
  }
  .icon {
    width: 16px;
    height: 16px;
    padding: 8px;
  }
  .shortcut {
    padding: 6px;
  }
  .top.selected {
    background: var(--palette-select);
  }
  .top:active {
    background: var(--palette-select);
  }
</style>
